- name: Install Raspberry Pi support tools
  apk:
    name: raspberrypi
    state: present

- name: Check current firmware configuration
  copy:
    src: usercfg.txt
    dest: /media/mmcblk0p1/usercfg.txt
  check_mode: true
  register: firmware

- name: Setup Firmware
  include_tasks: firmware.yml
  when: firmware.changed

- name: Enable community APK repository
  replace:
    path: /etc/apk/repositories
    regexp: '^#(http://.*/v.*/community)'
    replace: '\1'

- import_tasks: avahi.yml
- import_tasks: rngd.yml
- import_tasks: cleaning.yml

# https://bugs.alpinelinux.org/issues/8028
- name: Workaround for busybox syslogd -Z option broken
  replace:
    path: /etc/conf.d/syslog
    regexp: '^SYSLOGD_OPTS="(.*)-Z(.*)"'
    replace: 'SYSLOGD_OPTS="\1\2"'
  notify: restart syslogd
