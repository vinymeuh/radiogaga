- name: Create staging directory
  tempfile:
    state: directory
  register: tempfile

- name: Create sub directories in staging directory
  file:
    path: "{{ tempfile.path }}/{{ item }}" 
    state: directory
    mode: 0755
  loop:
    - etc
    - etc/network
    - etc/runlevels/boot
    - etc/runlevels/default
    - etc/runlevels/sysinit
    - etc/ssh

- name: Generate configuration files
  template:
    src: "{{ item }}"
    dest: "{{ tempfile.path }}/{{ item }}"
  loop:
    - etc/hostname
    - etc/hosts
    - etc/network/interfaces
    - etc/ssh/myca.pub
    - etc/ssh/sshd_config

- name: Create symbolic links
  file:
    src: "{{ item.src }}"
    dest: "{{ tempfile.path }}/{{ item.dest }}"
    state: link
    force: yes
    follow: no
  loop:
    - { dest: "etc/runlevels/boot/bootmisc", src: "/etc/init.d/bootmisc" }
    - { dest: "etc/runlevels/boot/hostname", src: "/etc/init.d/hostname" }
    - { dest: "etc/runlevels/boot/modules", src: "/etc/init.d/modules" }
    - { dest: "etc/runlevels/boot/networking", src: "/etc/init.d/networking" }
    - { dest: "etc/runlevels/boot/urandom", src: "/etc/init.d/urandom" }
    - { dest: "etc/runlevels/sysinit/devfs", src: "/etc/init.d/devfs" }
    - { dest: "etc/runlevels/sysinit/dmesg", src: "/etc/init.d/dmesg" }
    - { dest: "etc/runlevels/sysinit/hwdrivers", src: "/etc/init.d/hwdrivers" }
    - { dest: "etc/runlevels/sysinit/mdev", src: "/etc/init.d/mdev" }
    - { dest: "etc/runlevels/sysinit/modloop", src: "/etc/init.d/modloop" }

- name: Create overlay file
  command: gnutar czf {{ bootstrap.initialize.hostname | mandatory }}.apkovl.tar.gz --owner=0 --group=0 etc
  args:
    chdir: "{{ tempfile.path }}"
    warn: no

- name: Copy overlay file on {{ bootstrap.mount_point }}
  copy:
    src: "{{ tempfile.path }}/{{ bootstrap.initialize.hostname | mandatory }}.apkovl.tar.gz"
    dest: "{{ bootstrap.mount_point | mandatory }}"

- name: Delete staging directory
  file:
    path: "{{ tempfile.path }}/"
    state: absent
