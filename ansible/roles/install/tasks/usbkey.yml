- name: Enable and Mount USB key
  mount:
    path: "{{ usbkey_mnt }}"
    src: "LABEL={{ usbkey_label }}"
    fstype: f2fs
    opts: noatime
    passno: "2"
    state: mounted

- name: Create a directory for mpd on USBKEY
  file:
    path: "{{ usbkey_mnt }}/mpd"
    state: directory
    owner: mpd
    group: audio
    mode: 0755

- name: Create music & playlists directories
  file:
    path: "{{ item }}"
    state: directory
    owner: mpd
    group: audio
    mode: 0777
  with_items:
    - "{{ usbkey_mnt }}/mpd/music"
    - "{{ usbkey_mnt }}/mpd/playlists"

- name: Check if file mpd.db exists
  stat:
    path: "{{ usbkey_mnt }}/mpd/mpd.db"
  register: mpddb

- name: Fix attributes on file mpd.db
  file:
    path: "{{ usbkey_mnt }}/mpd/mpd.db"
    state: file
    owner: mpd
    group: audio
    mode: 0644
  when: mpddb.stat.exists == true